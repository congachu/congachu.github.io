---
title: "[Infosec] File Upload & Download Vulnerability 정리: 개념·예시·대응"
date: 2025-09-11 22:20:00 +0900
categories: [보안, Web]
tags: [웹해킹, FileUpload, FileDownload, PathTraversal, WebShell, 취약점]
description: "파일을 이용하라"
author: "송지민"
toc: true
---
# 파일 하나로 서버를 뒤흔드는 치명적 취약점

---
> ⚠️ 이 글은 **보안 학습/방어 목적**으로 작성되었습니다. 모든 실습은 로컬/테스트 환경에서만 진행하세요.

---

## File Upload Vulnerability (파일 업로드 취약점)

웹 서비스가 이용자 파일을 서버에 저장하는 과정에서 발생하는 취약점.  
특히 **이용자가 업로드될 파일 이름을 조작할 수 있을 때** 발생하기 쉽습니다.

- 취약 패턴:  
  - `f.save("./uploads/" + f.filename)` 처럼 **입력값 그대로 파일명 사용**  
  - 이메일/닉네임 등 사용자 입력을 파일명에 포함시키는 경우  
- 위험:  
  - **Path Traversal** → 서버 임의 위치에 파일 저장/덮어쓰기  
  - **악성 파일 업로드** → 웹셸 실행, 악성 HTML 실행

---

## Path Traversal 업로드

**정의:** 업로드 경로 제한을 우회하여 **임의 디렉토리에 파일을 저장**하는 취약점.

### 예시 서버 코드 (Flask)
```python
from flask import Flask, request
app = Flask(__name__)
@app.route('/fileUpload', methods=['POST'])
def upload_file():
    f = request.files['file']
    f.save("./uploads/" + f.filename)
    return 'Upload Success'
```

### 정상 요청
```http
POST /fileUpload HTTP/1.1
Content-Disposition: form-data; name="file"; filename="test.txt"
(upload test)
```
→ `./uploads/test.txt` 에 정상 저장

### 악의적 요청
```http
POST /fileUpload HTTP/1.1
Content-Disposition: form-data; name="file"; filename="../hack.py"
(malicious content)
```
→ `../hack.py` 로 상위 디렉토리에 저장됨 → 심지어 `app.py` 같은 중요한 코드도 덮어쓰기 가능

---

## 악성 파일 업로드

**정의:** 업로드된 파일의 확장자/내용을 제대로 검사하지 않아 **코드 실행**이나 **악성 리소스 제공**이 가능한 취약점.

### 1) 웹셸 업로드
서버가 `.php`, `.jsp`, `.asp` 파일을 CGI로 실행하도록 설정된 경우:

```apache
<FilesMatch ".+\.ph(p[3457]?|t|tml)$">
    SetHandler application/x-httpd-php
</FilesMatch>
```
→ 공격자가 `shell.php` 업로드 + GET 요청 시, **서버에서 코드 실행** 발생

### 2) 악성 리소스 업로드
브라우저는 **파일 확장자 / Content-Type** 에 따라 해석을 달리합니다.  
- 공격자가 `exploit.html` 업로드 성공 →  
- 접근 URL: `https://target.com/uploads/exploit.html` →  
- 브라우저에서 HTML 해석 → **저장된 XSS** 실행 가능

---

## File Download Vulnerability (파일 다운로드 취약점)

웹 서비스가 서버 파일을 내려주는 과정에서 발생.  
**이용자가 다운로드 파일 이름을 직접 조작할 수 있을 때** 문제가 됩니다.

- 핵심 공격: **Path Traversal**을 이용해 서버 임의 파일 읽기
- 위험: 비밀번호, 소스코드, 설정 파일 유출

### 예시 URL 패턴 (취약)
- `https://exams.com/download/?filename=notes.txt`
- `https://exams.com/download/?filename=../../../../etc/passwd`
- `https://exams.com/download/images.php?fn=9gs03j1jf0ajf1.png`

---

## 대응 방법 (Upload & Download 공통)

1. **업로드 디렉토리 고정**  
   - `/var/www/uploads/` 등 **전용 디렉토리**만 허용  
   - 웹에서 직접 실행되지 않도록 설정(예: `uploads`는 PHP 실행 금지)

2. **파일명 검증/랜덤화**  
   - `uuid` 등 무작위 이름으로 저장 → 원본 이름은 DB에만 기록  
   - `..`, `/`, `\` 등 경로 제어 문자 필터링

3. **확장자/콘텐츠 검증**  
   - 허용된 확장자만 (`.jpg`, `.png`, `.pdf` 등)  
   - MIME 타입/매직넘버 검사 → 단순히 Content-Type 헤더만 믿지 말 것

4. **다운로드 시 화이트리스트 적용**  
   - DB/서버에 등록된 파일만 다운로드 허용  
   - 절대 `?filename=` 식의 직접 참조 금지

5. **권한 분리**  
   - 업로드/다운로드 서버는 웹앱 계정 권한 최소화  
   - 실행 권한 제거 (예: 업로드 폴더는 `noexec` 마운트)

---

## 테스트 페이로드 예시

- 업로드 Path Traversal:  
  - `filename="../hack.py"`  
  - `filename="..\..\win.ini"` (윈도우)  

- 악성 업로드:  
  - `shell.php` → `<?php system($_GET['cmd']); ?>`  
  - `exploit.html` → `<script>alert(document.cookie)</script>`  

- 다운로드 Path Traversal:  
  - `?filename=../../../../etc/passwd`  
  - `?filename=..\..\boot.ini` (윈도우)

---

## 요약

- 파일 업로드/다운로드 취약점은 **단순한 입출력 처리 문제 같아 보여도 서버 장악·정보 유출로 이어질 수 있는 치명적인 공격면**.  
- 핵심 방어: **고정 디렉토리, 랜덤 파일명, 확장자+콘텐츠 검증, 화이트리스트 다운로드**.  
- 한 마디로: 🔥 **“파일 하나로 서버를 무너뜨리는 취약점”**
